<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMA Management Portal - Ultimate</title>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --primary: #24b47e; 
            --secondary: #3b82f6; --text: #f1f5f9; --border: #334155; --orange: #f59e0b;
        }
        [data-theme="day"] {
            --bg-body: #f4f6f8; --bg-card: #ffffff; --text: #1e293b; --border: #cbd5e1;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; overflow-x: hidden; }
        
        /* Backdrop Overlay for mobile */
        #sidebarOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 8999; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); padding: 12px; border-radius: 10px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .stat-card p { margin: 5px 0; font-size: 18px; font-weight: 700; color: var(--primary); }

        /* üîç Action Bar (Laptop vs Mobile Logic) */
        .action-bar { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 10px; border-radius: 12px; margin-bottom: 20px; }
        .action-bar input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white; outline: none; }
        
        .btn-box { width: 42px; height: 42px; min-width: 42px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; transition: 0.2s; }
        .btn-text-only { width: auto; padding: 0 20px; }

        /* Sidebar */
        .content-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { background: var(--bg-card); padding: 20px; border-radius: 15px; height: 600px; display: flex; flex-direction: column; z-index: 9000; transition: 0.3s; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .theme-icon { cursor: pointer; color: var(--orange); font-size: 18px; }

        .area-list-wrapper { flex-grow: 1; overflow-y: auto; margin-top: 10px; }

        /* üìÇ Nested Accordion Style (Mobile) */
        .dist-group { margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .dist-header { padding: 12px; background: rgba(255,255,255,0.05); cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; }
        .dist-areas { display: none; padding: 5px; }
        .dist-areas.active { display: block; }
        
        .area-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; }
        .area-item:hover, .area-item.active { background: var(--primary); color: white; border-radius: 4px; }
        .all-areas { background: rgba(36,180,126,0.1); font-weight: bold; margin-top: 10px; padding: 14px; text-align: center; border-radius: 10px; cursor: pointer; border: 1px dashed var(--primary); }

        /* Table */
        .table-container { background: var(--bg-card); border-radius: 12px; overflow: hidden; }
        .table-wrapper { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary); color: white; position: sticky; top: 0; z-index: 10; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; white-space: nowrap; }

        @media (max-width: 1024px) {
            .content-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 280px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            #sidebarOverlay.active { display: block; }
            .btn-text-only { display: none; } /* Hide text buttons on mobile */
            .btn-mobile-icon { display: flex !important; } /* Show icon buttons on mobile */
            
            thead { display: none; }
            tr { display: block; border: 1px solid var(--border); margin-bottom: 12px; padding: 12px; border-radius: 10px; background: var(--bg-card); }
            td { display: flex; justify-content: space-between; border: none; text-align: right; padding: 8px 0; border-bottom: 1px solid var(--border); white-space: normal; }
            td::before { content: attr(data-label); font-weight: bold; color: var(--primary); text-align: left; margin-right: 10px; }
        }
    </style>
</head>
<body>

    <div id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="stats-grid">
        <div class="stat-card"><h4>Total Records</h4><p id="stat-total">0</p></div>
        <div class="stat-card" style="border-left-color: var(--secondary);"><h4>COMP</h4><p id="stat-installed">0</p></div>
        <div class="stat-card" style="border-left-color: var(--orange);"><h4>Pending</h4><p id="stat-pending">0</p></div>
        <div class="stat-card" style="border-left-color: #a855f7;"><h4>AREAS</h4><p id="stat-areas">0</p></div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar">
        <button class="btn-box" style="background:var(--secondary);" onclick="toggleSidebar()"><i class="fas fa-filter"></i></button>
        <input type="text" id="mainSearch" placeholder="Search customer...">
        
        <!-- Icons for Mobile -->
        <button onclick="performSearch()" class="btn-box" style="background:var(--primary);"><i class="fas fa-search"></i></button>
        <button onclick="resetFilters()" class="btn-box" style="background:#64748b;"><i class="fas fa-undo"></i></button>
    </div>

    <div class="content-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <b>AREA SUMMARY</b> 
                <div>
                    <i class="fas fa-moon theme-icon" id="themeIcon" onclick="cycleTheme()" style="margin-right: 15px;"></i>
                    <i class="fas fa-times" onclick="toggleSidebar()" style="color:red; font-size:22px; cursor:pointer;"></i>
                </div>
            </div>
            <input type="text" id="sideSearch" placeholder="Filter list..." onkeyup="filterSidebar()" style="margin:10px 0; padding:10px; border-radius:5px; background:rgba(0,0,0,0.2); color:white; border:1px solid var(--border);">
            <div class="area-list-wrapper" id="areaList">Loading...</div>
            <div class="all-areas" onclick="filterByAll()">üåç ALL AREAS <strong id="allCount">0</strong></div>
        </aside>

        <main class="table-container">
            <div class="table-wrapper">
                <table id="mainTable">
                    <thead><tr><th>View</th><th>Customer Name</th><th>Mobile</th><th>SRN</th><th>Area</th><th>Status</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content:space-between; padding:15px; background:var(--bg-card);">
                <button onclick="changePage(-1)" style="padding:8px 15px; border-radius:5px; border:none; background:var(--border); color:var(--text);">Prev</button>
                <span id="pageInfo" style="font-weight:bold;">Page 1</span>
                <button onclick="changePage(1)" style="padding:8px 15px; border-radius:5px; border:none; background:var(--border); color:var(--text);">Next</button>
            </div>
        </main>
    </div>

<script>
    const SUPABASE_URL = 'https://tqvyjyseaugdtblqacle.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxdnlqeXNlYXVnZHRibHFhY2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjcwNDksImV4cCI6MjA4MzgwMzA0OX0.hLknKsbneugFWUaQ-DjfnI1ZTbD98BY_uc0ijcIZnSE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentData = [], page = 0, activeArea = null, currentTheme = 'night';
    const cols = ["Customer Name", "Contact Number", "Service Request Number", "Area", "Status"];

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }

    function cycleTheme() {
        currentTheme = (currentTheme === 'night') ? 'day' : 'night';
        document.body.setAttribute('data-theme', currentTheme);
        document.getElementById('themeIcon').className = (currentTheme === 'night') ? 'fas fa-moon' : 'fas fa-sun';
    }

    async function loadStats() {
        try {
            const { count } = await supabaseClient.from('SEARCH YOU DATA').select('*', { count: 'exact', head: true });
            document.getElementById('stat-total').innerText = count.toLocaleString();
            document.getElementById('allCount').innerText = count.toLocaleString();
            
            const { data: nestedData } = await supabaseClient.rpc('get_nested_summary');
            const list = document.getElementById('areaList');
            list.innerHTML = '';
            document.getElementById('stat-areas').innerText = nestedData.length;

            const groups = {};
            nestedData.forEach(d => {
                if(!groups[d.district_name]) groups[d.district_name] = [];
                groups[d.district_name].push(d);
            });

            Object.keys(groups).forEach(dist => {
                const total = groups[dist].reduce((sum, item) => sum + parseInt(item.total_count), 0);
                if(window.innerWidth < 1024) { // Mobile: Folders
                    const distDiv = document.createElement('div');
                    distDiv.className = 'dist-group';
                    distDiv.innerHTML = `<div class="dist-header" onclick="this.nextElementSibling.classList.toggle('active')"><span>üìÇ ${dist}</span> <strong>${total}</strong></div><div class="dist-areas">${groups[dist].map(a => `<div class="area-item" onclick="filterByArea('${a.area_name}', this)"><span>üìç ${a.area_name}</span> <strong>${a.total_count}</strong></div>`).join('')}</div>`;
                    list.appendChild(distDiv);
                } else { // Laptop: Normal List
                    groups[dist].forEach(a => {
                        list.innerHTML += `<div class="area-item" onclick="filterByArea('${a.area_name}', this)"><span>${a.area_name}</span> <strong>${a.total_count}</strong></div>`;
                    });
                }
            });

            const { count: sc } = await supabaseClient.from('SEARCH YOU DATA').select('*', { count: 'exact', head: true }).eq('Status', 'COMP');
            document.getElementById('stat-installed').innerText = (sc || 0).toLocaleString();
            document.getElementById('stat-pending').innerText = (count - (sc || 0)).toLocaleString();
        } catch(e) { console.error(e); }
    }

    async function fetchMainData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:30px;">üîç Loading...</td></tr>';
        const search = document.getElementById('mainSearch').value.trim();
        let q = supabaseClient.from('SEARCH YOU DATA').select('*');
        if (search) {
            if(/^\d+$/.test(search)) q = q.or(`"Service Request Number".eq.${search},"Contact Number".eq.${search}`);
            else q = q.or(`"Customer Name".ilike.%${search}%,"Locality".ilike.%${search}%,"Area".ilike.%${search}%`);
        }
        if (activeArea) q = q.eq('Area', activeArea);
        const { data } = await q.order('Customer Name').range(page*50, (page+1)*50-1);
        currentData = data; tbody.innerHTML = '';
        data.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td data-label="View"><button onclick="alert(JSON.stringify(row,null,2))" style="padding:5px 10px; background:var(--primary); border:none; border-radius:5px; color:white;">üëÅÔ∏è</button></td>`;
            cols.forEach(c => tr.innerHTML += `<td data-label="${c}">${row[c] || '-'}</td>`);
            tbody.appendChild(tr);
        });
        document.getElementById('pageInfo').innerText = `Page ${page + 1}`;
    }

    function filterByArea(area, el) { activeArea = area; page = 0; document.querySelectorAll('.area-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); if(window.innerWidth < 1024) toggleSidebar(); fetchMainData(); }
    function filterByAll() { activeArea = null; page = 0; document.querySelectorAll('.area-item').forEach(i => i.classList.remove('active')); if(window.innerWidth < 1024) toggleSidebar(); fetchMainData(); }
    function performSearch() { page = 0; fetchMainData(); }
    function resetFilters() { document.getElementById('mainSearch').value = ''; filterByAll(); }
    function changePage(s) { if(page + s >= 0) { page += s; fetchMainData(); } }
    function exportToExcel() { const ws = XLSX.utils.json_to_sheet(currentData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "DMA_Export.xlsx"); }
    function filterSidebar() { const val = document.getElementById('sideSearch').value.toUpperCase(); document.querySelectorAll('.area-item').forEach(i => i.style.display = i.innerText.toUpperCase().includes(val) ? '' : 'none'); }

    window.onload = () => { loadStats(); fetchMainData(); };
</script>
</body>
</html>