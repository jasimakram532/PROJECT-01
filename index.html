<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMA Portal - Corner Theme & Fixed Layout</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- THEMES --- */
        :root {
            --bg-body: #f4f6f8; --bg-card: #ffffff; --text: #1e293b; --border: #cbd5e1; --primary: #24b47e; --secondary: #3b82f6; --orange: #f59e0b;
        }
        [data-theme="night"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text: #f1f5f9; --border: #334155;
        }
        [data-theme="dark"] {
            --bg-body: #000000; --bg-card: #121212; --text: #ffffff; --border: #222222;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }
        
        /* --- CORNER THEME TOGGLE --- */
        .corner-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--orange);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 20px;
            transition: transform 0.2s;
        }
        .corner-toggle:hover { transform: scale(1.1); }

        /* Stats Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; padding-right: 60px; /* Space for toggle */ }
        .stat-card { background: var(--bg-card); padding: 15px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h4 { font-size: 11px; text-transform: uppercase; margin: 0; opacity: 0.7; }
        .stat-card p { margin: 8px 0; font-size: 24px; font-weight: 700; color: var(--primary); }
        .status-breakdown { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; border-top: 1px solid var(--border); padding-top: 8px; }
        .status-tag { font-size: 10px; padding: 2px 6px; background: rgba(100,100,100,0.1); border-radius: 4px; }

        /* Action Bar */
        .action-bar { display: flex; gap: 10px; background: var(--bg-card); padding: 12px; border-radius: 12px; margin-bottom: 20px; align-items: center; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .action-bar input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text); outline: none; }
        .icon-btn { width: 45px; height: 45px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .excel-btn { background: #1d6f42; }
        .filter-btn { background: var(--secondary); display: none; }

        /* Content Layout */
        .content-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; align-items: start; }
        .sidebar { background: var(--bg-card); padding: 15px; border-radius: 12px; height: 600px; display: flex; flex-direction: column; position: sticky; top: 90px; }
        .area-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; border-top: 1px solid var(--border); }
        .area-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; }
        .area-item:hover, .area-item.active { background: var(--primary); color: white; border-radius: 4px; }
        .all-areas-item { margin-top: auto; border-top: 2px solid var(--primary); background: rgba(36, 180, 126, 0.1); font-weight: bold; }

        /* Table */
        .table-container { background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table-wrapper { overflow-x: auto; max-height: 550px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary); color: white; position: sticky; top: 0; z-index: 10; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; white-space: nowrap; }

        /* Shimmer Animation */
        .skeleton { height: 20px; background: linear-gradient(90deg, var(--border) 25%, var(--bg-body) 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* Responsive Mobile */
        @media (max-width: 1024px) {
            .content-layout { grid-template-columns: 1fr; }
            .filter-btn { display: flex; }
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; z-index: 1200; width: 280px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            .stats-grid { padding-right: 0; margin-top: 40px; }
            thead { display: none; }
            tr { display: block; border: 1px solid var(--border); margin-bottom: 15px; border-radius: 10px; padding: 12px; background: var(--bg-card); }
            td { display: flex; justify-content: space-between; border: none; text-align: right; padding: 10px 0; border-bottom: 1px solid var(--border); white-space: normal; }
            td::before { content: attr(data-label); font-weight: bold; color: var(--primary); text-align: left; margin-right: 10px; font-size: 12px; }
        }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--bg-card); margin: 5% auto; padding: 25px; width: 85%; border-radius: 15px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--primary); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .detail-item { padding: 10px; background: var(--bg-body); border-radius: 6px; font-size: 13px; border-left: 4px solid var(--primary); }
        .view-btn { padding: 6px 12px; background: var(--secondary); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body data-theme="night">

    <!-- ‚òÄÔ∏èüåô CORNER THEME TOGGLE BUTTON -->
    <button class="corner-toggle" onclick="cycleTheme()" id="themeIcon">
        <i class="fas fa-moon"></i>
    </button>

    <!-- 1. DASHBOARD -->
    <div class="stats-grid">
        <div class="stat-card"><h4>Total Records</h4><p id="stat-total">0</p></div>
        <div class="stat-card" style="border-left-color: var(--secondary);"><h4>Installed (COMP)</h4><p id="stat-installed">0</p></div>
        <div class="stat-card" style="border-left-color: var(--orange);">
            <h4>Pending Work</h4><p id="stat-pending">0</p>
            <div class="status-breakdown" id="statusBreakdown"></div>
        </div>
        <div class="stat-card" style="border-left-color: #a855f7;"><h4>Total Areas</h4><p id="stat-areas">0</p></div>
    </div>

    <!-- 2. ACTION BAR (Clean - no theme icon here) -->
    <div class="action-bar">
        <button class="icon-btn filter-btn" onclick="toggleSidebar()"><i class="fas fa-filter"></i></button>
        <input type="text" id="mainSearch" placeholder="Search Customer Name, SRN or Mobile...">
        <button class="icon-btn excel-btn" onclick="exportToExcel()" title="Export to Excel"><i class="fas fa-file-excel"></i></button>
    </div>

    <!-- 3. MAIN CONTENT -->
    <div class="content-layout">
        <aside class="sidebar" id="sidebar">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <b>AREA SUMMARY</b>
                <button onclick="toggleSidebar()" class="filter-btn" style="background:none; color:red; border:none; font-size: 24px;">√ó</button>
            </div>
            <input type="text" id="sideSearch" placeholder="Filter area..." onkeyup="filterSidebar()" style="margin-top:10px; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--bg-body); color:var(--text);">
            <div class="area-list" id="areaList"></div>
            <div class="area-item all-areas-item" id="all-areas-btn" onclick="filterByAll()">
                <span>üåç ALL AREAS</span> <strong id="allCount">0</strong>
            </div>
        </aside>

        <main class="table-container">
            <div class="table-wrapper">
                <table id="mainTable">
                    <thead>
                        <tr id="tableHeaders">
                            <th>View</th>
                            <th>Customer Name</th>
                            <th>Contact Number</th>
                            <th>Service Request Number</th>
                            <th>Business Partner</th>
                            <th>Area</th>
                            <th>Status</th>
                            <th>Meter No.</th>
                            <th>District</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content:space-between; padding:15px; background:var(--bg-card); border-top:1px solid var(--border);">
                <button onclick="changePage(-1)" class="icon-btn" style="background:var(--border); color:var(--text); width:80px;">Prev</button>
                <span id="pageInfo" style="align-self:center; font-weight:bold;">Page 1</span>
                <button onclick="changePage(1)" class="icon-btn" style="background:var(--border); color:var(--text); width:80px;">Next</button>
            </div>
        </main>
    </div>

    <!-- 4. MODAL -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="color:var(--primary); margin-top:0;">Customer Details</h3>
            <div id="modalBody" class="detail-grid"></div>
            <button onclick="closeModal()" class="btn btn-primary" style="margin-top:20px; width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer;">Close</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://tqvyjyseaugdtblqacle.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxdnlqeXNlYXVnZHRibHFhY2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjcwNDksImV4cCI6MjA4MzgwMzA0OX0.hLknKsbneugFWUaQ-DjfnI1ZTbD98BY_uc0ijcIZnSE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const columns = ["Customer Name", "Contact Number", "Service Request Number", "Business Partner", "Area", "Status", "Meter No.", "District"];
    let currentData = [], page = 0, activeArea = null, currentTheme = 'night';

    // --- 1. THEME TOGGLE ICON ---
    function cycleTheme() {
        const themes = ['day', 'night', 'dark'];
        const icons = { day: 'fa-sun', night: 'fa-moon', dark: 'fa-circle' };
        currentTheme = themes[(themes.indexOf(currentTheme) + 1) % 3];
        document.body.setAttribute('data-theme', currentTheme);
        document.getElementById('themeIcon').innerHTML = `<i class="fas ${icons[currentTheme]}"></i>`;
    }

    // --- 2. STATS & SIDEBAR ---
    async function loadStats() {
        const { count } = await supabaseClient.from('SEARCH YOU DATA').select('*', { count: 'exact', head: true });
        document.getElementById('stat-total').innerText = count.toLocaleString();
        document.getElementById('allCount').innerText = count.toLocaleString();
        
        const { data: summary } = await supabaseClient.rpc('get_area_summary');
        const list = document.getElementById('areaList');
        document.getElementById('stat-areas').innerText = summary.length;
        summary.forEach(a => {
            list.innerHTML += `<div class="area-item" onclick="filterByArea('${a.area_name}', this)"><span>${a.area_name}</span> <strong>${a.total_count}</strong></div>`;
        });

        const statuses = ['COMP', 'MIST', 'MIOC', 'MIDN', 'RFC'];
        let bHtml = '';
        for(let s of statuses) {
            const { count: sc } = await supabaseClient.from('SEARCH YOU DATA').select('*', { count: 'exact', head: true }).eq('Status', s);
            if(s === 'COMP') document.getElementById('stat-installed').innerText = (sc || 0).toLocaleString();
            bHtml += `<span class="status-tag">${s}: ${sc || 0}</span>`;
        }
        document.getElementById('statusBreakdown').innerHTML = bHtml;
        const totalNum = parseInt(document.getElementById('stat-total').innerText.replace(/,/g,''));
        const compNum = parseInt(document.getElementById('stat-installed').innerText.replace(/,/g,''));
        document.getElementById('stat-pending').innerText = (totalNum - compNum).toLocaleString();
    }

    // --- 3. FETCH DATA ---
    async function fetchMainData() {
        renderSkeleton();
        const search = document.getElementById('mainSearch').value.trim();
        let q = supabaseClient.from('SEARCH YOU DATA').select('*');
        
        if (search) {
            const isNum = /^\d+$/.test(search);
            if(isNum) {
                q = q.or(`"Service Request Number".eq.${search},"Contact Number".eq.${search},"Business Partner".eq.${search},"Customer Name".ilike.%${search}%`);
            } else {
                q = q.or(`"Customer Name".ilike.%${search}%,"Locality".ilike.%${search}%,"Area".ilike.%${search}%`);
            }
            if(window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('active'); // Hide sidebar on mobile search
        }
        if (activeArea) q = q.eq('Area', activeArea);

        const { data, error } = await q.order('Customer Name').range(page*50, (page+1)*50-1);
        if (error) return;
        currentData = data;
        renderTable(data);
    }

    function renderSkeleton() {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        for(let i=0; i<8; i++) { body.innerHTML += `<tr><td colspan="10"><div class="skeleton"></div></td></tr>`; }
    }

    function renderTable(data) {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        if(!data.length) { body.innerHTML = '<tr><td colspan="10" style="text-align:center">No records found.</td></tr>'; return; }
        
        data.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td data-label="Action"><button class="view-btn" onclick="showDetails(${idx})">üëÅÔ∏è Details</button></td>`;
            columns.forEach(c => {
                tr.innerHTML += `<td data-label="${c}">${row[c] || '-'}</td>`;
            });
            body.appendChild(tr);
        });
        document.getElementById('pageInfo').innerText = `Page ${page + 1}`;
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(currentData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DMA_Records");
        XLSX.writeFile(wb, "DMA_Export.xlsx");
    }

    function showDetails(idx) {
        const row = currentData[idx];
        const body = document.getElementById('modalBody');
        body.innerHTML = '';
        Object.keys(row).sort().forEach(k => {
            body.innerHTML += `<div class="detail-item"><b>${k.replace(/_/g,' ')}:</b> ${row[k] || '-'}</div>`;
        });
        document.getElementById('detailModal').style.display = 'block';
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
    
    function filterByArea(area, el) {
        activeArea = area; page = 0;
        document.querySelectorAll('.area-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        if(window.innerWidth < 1024) toggleSidebar();
        fetchMainData();
    }
    
    function filterByAll() {
        activeArea = null; page = 0;
        document.querySelectorAll('.area-item').forEach(i => i.classList.remove('active'));
        document.getElementById('all-areas-btn').classList.add('active');
        if(window.innerWidth < 1024) toggleSidebar();
        fetchMainData();
    }

    function filterSidebar() {
        const val = document.getElementById('sideSearch').value.toUpperCase();
        document.querySelectorAll('.area-list .area-item').forEach(i => {
            i.style.display = i.innerText.toUpperCase().includes(val) ? '' : 'none';
        });
    }

    function changePage(s) { if(page + s >= 0) { page += s; fetchMainData(); } }
    document.getElementById('mainSearch').addEventListener('keypress', (e) => { if(e.key === 'Enter') { page=0; fetchMainData(); } });

    window.onload = () => { loadStats(); fetchMainData(); };
</script>
</body>
</html>